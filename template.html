<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Interattivo Completo</title>
  <style>
    /* --- STILI BASE --- */
    html { font-size: 16px; scroll-behavior: smooth; }

    body { font-family: 'Segoe UI', sans-serif; background-color: #1c1f2b; color: #fff; padding: 20px; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #1a73e8; margin-bottom: 30px; }
    .stats { display: flex; justify-content: space-between; margin-bottom: 15px; }

    .card { background-color: #2a2e3d; color: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }

    /* --- RISPOSTE (Student Mode) --- */
    .risposta { 
      background-color: #ffffff; 
      color: #000; 
      border: 2px solid #ccc; 
      margin: 10px 0; 
      padding: 15px 20px; 
      border-radius: 8px; 
      font-size: 1.2rem; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.25s ease-in-out; 
      opacity: 0; 
      transform: translateY(10px); 
      animation: fadeInUp 0.6s ease forwards; 
    }
    .risposta:hover { transform: scale(1.03); box-shadow: 0 0 12px rgba(255,255,255,0.3); }
    .corretta { background-color: #28a745; color: white; border-color: #28a745; }
    .sbagliata { background-color: #dc3545; color: white; border-color: #dc3545; }

    /* --- RISPOSTE DOCENTE (Statiche) --- */
    .risposta-docente {
        padding: 12px 15px;
        margin: 8px 0;
        border-radius: 6px;
        font-size: 1.1rem;
        background-color: #fff;
        color: #333;
        border: 1px solid #ccc;
    }
    .docente-corretta {
        background-color: #28a745; 
        color: white; 
        border-color: #28a745;
        font-weight: bold;
    }

    /* --- BOTTONI --- */
    button { 
      padding: 10px 16px; 
      margin: 5px; 
      border: none; 
      border-radius: 6px; 
      background-color: #1a73e8; 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.25s ease-in-out; 
      opacity: 0; 
      transform: translateY(10px); 
      animation: fadeInUp 0.6s ease forwards; 
    }
    button:hover { background-color: #155ab6; transform: scale(1.07); box-shadow: 0px 0px 15px rgba(26,115,232,0.6); }
    button:active { transform: scale(0.95); box-shadow: 0px 0px 8px rgba(0,0,0,0.3) inset; }
    .btn-danger { background-color: #d93025; }
    .btn-danger:hover { background-color: #b5271b; }

    /* --- GRIGLIA MODULI --- */
    .moduli-grid { 
        display: none; 
        grid-template-columns: 1fr; 
        gap: 10px; 
        max-width: 600px; 
        margin: auto; 
    }

    /* --- RECAP --- */
    #risposte { display: grid; gap: 1rem; }

    .domandaRecap { background-color: #2f3347; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #444; }
    .domandaRecap strong { display: block; margin-bottom: 6px; font-size: 1.1em; color: #1a73e8; }
    .domandaRecap div { margin: 4px 0; }
    
    /* --- STILI AGGIUNTIVI PER IL RECAP --- */
    .recap-card { 
        background-color: #2a2e3d; 
        padding: 15px; 
        margin-bottom: 15px; 
        border-radius: 8px; 
        border-left: 6px solid #444; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .recap-correct { border-left-color: #28a745; }
    .recap-wrong { border-left-color: #dc3545; }

    .recap-text { font-size: 1.1rem; margin: 5px 0; }
    .text-success { color: #28a745; font-weight: bold; }
    .text-danger { color: #dc3545; font-weight: bold; }

    /* --- ANIMAZIONI --- */
    @keyframes fadeInUp { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    .progress-bar-animate { 
      transition: width 0.4s ease-in-out; 
    }
  </style> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script> 
</head> 
<body> 
   
  <div id="start-container" style="text-align: center; margin-bottom: 30px;"> 
    <h1>Benvenuto!</h1> 
    <button onclick="setDocenteMode(false)">üìù Modalit√† Studente</button> 
    <button onclick="setDocenteMode(true)">üë©‚Äçüè´ Modalit√† Docente</button> 
  </div> 

  <div id="quiz-buttons" style="margin-top:20px; display:none; text-align:center;"> 
    <h2 id="quiz-title"></h2> 
      
    <div id="lezione-container" style="max-width: 600px; margin: 10px auto; display: none;"> 
      <button onclick="mostraModuliQuiz(1)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px;">üìö Lezione 1 - Basi PC</button> 
      <button onclick="mostraModuliQuiz(2)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #6f42c1;">üöÄ Lezione 2 - Gestione File</button>
      <button onclick="mostraModuliQuiz(3)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #e65100;">üåü Lezione 3 - Internet</button> 
      <button onclick="mostraModuliQuiz(4)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #20c997;">üß† Lezione 4 - Email,PEC e Identit√° Digitale</button> 
      <button onclick="mostraModuliQuiz(5)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #dc3545;">üß™ Lezione 5 - Sicurezza Informatica e Cloud</button>
      
      <button onclick="mostraModuliQuiz(6)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #17a2b8;">üìò Lezione 6 - Video scrittura Professionale</button>
      <button onclick="mostraModuliQuiz(7)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #6610f2;">üìô Lezione 7 - Excel</button>
      <button onclick="mostraModuliQuiz(8)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #fd7e14;">üìó Lezione 8 - Presentation Design</button>
      <button onclick="mostraModuliQuiz(9)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #e83e8c;">üìì Lezione 9 - Social Media e Consapevolezza Digitale</button>
      <button onclick="mostraModuliQuiz(10)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #6f42c1;">üìî Lezione 10 - AI e Tecnologie Emergenti</button>
      <button onclick="mostraModuliQuiz(11)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #28a745;">üìí Lezione 11 - Competenze Digitali Professionali</button>
      <button onclick="mostraModuliQuiz(12)" style="width: 100%; font-size: 1.3rem; padding: 20px; margin-bottom: 15px; background-color: #343a40;">üìú Lezione 12 - Recap Corso Competenze Digitali</button>
    </div> 
      
    <div id="moduli-lezione-1" class="moduli-grid"> 
      <h3 style="color: #1a73e8; margin-top:0;">Lezione 1</h3> 
      <button onclick="iniziaQuiz(1)">Esercizio #1</button> 
      <button onclick="iniziaQuiz(2)">Esercizio #2</button> 
      <button onclick="iniziaQuiz(3)">Esercizio #3</button> 
      <button onclick="iniziaQuiz(4)">Esercizio #4</button> 
      <button onclick="iniziaQuiz(5)">Esercizio #5</button> 
    </div> 

    <div id="moduli-lezione-2" class="moduli-grid"> 
      <h3 style="color: #6f42c1; margin-top:0;">Lezione 2</h3> 
      <button onclick="iniziaQuiz(6)">Esercizio #1</button> 
      <button onclick="iniziaQuiz(7)">Esercizio #2</button> 
      <button onclick="iniziaQuiz(8)">Esercizio #3</button> 
      <button onclick="iniziaQuiz(9)">Esercizio #4</button> 
      <button onclick="iniziaQuiz(10)">Esercizio #5</button> 
    </div> 

    <div id="moduli-lezione-3" class="moduli-grid"> 
      <h3 style="color: #e65100; margin-top:0;">Lezione 3</h3> 
      <button onclick="iniziaQuiz(11)">Esercizio #1</button> 
      <button onclick="iniziaQuiz(12)">Esercizio #2</button> 
      <button onclick="iniziaQuiz(13)">Esercizio #3</button> 
      <button onclick="iniziaQuiz(14)">Esercizio #4</button> 
      <button onclick="iniziaQuiz(15)">Esercizio #5</button> 
    </div> 
     
    <div id="moduli-lezione-4" class="moduli-grid"> 
      <h3>Lezione 4</h3> 
      <button onclick="iniziaQuiz(16)">Esercizio 1</button> 
      <button onclick="iniziaQuiz(17)">Esercizio 2</button> 
      <button onclick="iniziaQuiz(18)">Esercizio 3</button> 
      <button onclick="iniziaQuiz(19)">Esercizio 4</button> 
      <button onclick="iniziaQuiz(20)">Esercizio 5</button> 
    </div> 

    <div id="moduli-lezione-5" class="moduli-grid"> 
        <h3 style="color: #dc3545; margin-top:0;">Lezione 5</h3> 
        <button onclick="iniziaQuiz(21)">Esercizio 1</button> 
        <button onclick="iniziaQuiz(22)">Esercizio 2</button> 
        <button onclick="iniziaQuiz(23)">Esercizio 3</button> 
        <button onclick="iniziaQuiz(24)">Esercizio 4</button> 
        <button onclick="iniziaQuiz(25)">Esercizio 5</button> 
    </div> 

    <div id="moduli-lezione-6" class="moduli-grid"> 
        <h3 style="color: #17a2b8; margin-top:0;">Lezione 6</h3> 
        <button onclick="iniziaQuiz(26)">Esercizio 1</button> 
        <button onclick="iniziaQuiz(27)">Esercizio 2</button> 
        <button onclick="iniziaQuiz(28)">Esercizio 3</button> 
        <button onclick="iniziaQuiz(29)">Esercizio 4</button> 
        <button onclick="iniziaQuiz(30)">Esercizio 5</button> 
    </div>

    <div id="moduli-lezione-7" class="moduli-grid"> 
        <h3 style="color: #6610f2; margin-top:0;">Lezione 7</h3> 
        <button onclick="iniziaQuiz(31)">Esercizio 1</button> 
        <button onclick="iniziaQuiz(32)">Esercizio 2</button> 
        <button onclick="iniziaQuiz(33)">Esercizio 3</button> 
        <button onclick="iniziaQuiz(34)">Esercizio 4</button> 
        <button onclick="iniziaQuiz(35)">Esercizio 5</button> 
    </div>

    <div id="moduli-lezione-8" class="moduli-grid"> 
        <h3 style="color: #fd7e14; margin-top:0;">Lezione 8</h3> 
        <button onclick="iniziaQuiz(36)">Esercizio 1</button> 
        <button onclick="iniziaQuiz(37)">Esercizio 2</button> 
        <button onclick="iniziaQuiz(38)">Esercizio 3</button> 
        <button onclick="iniziaQuiz(39)">Esercizio 4</button> 
        <button onclick="iniziaQuiz(40)">Esercizio 5</button> 
    </div>

    <div id="moduli-lezione-9" class="moduli-grid"> 
        <h3 style="color: #e83e8c; margin-top:0;">Lezione 9</h3> 
        <button onclick="iniziaQuiz(41)">Esercizio 1</button> 
        <button onclick="iniziaQuiz(42)">Esercizio 2</button> 
        <button onclick="iniziaQuiz(43)">Esercizio 3</button> 
        <button onclick="iniziaQuiz(44)">Esercizio 4</button> 
        <button onclick="iniziaQuiz(45)">Esercizio 5</button> 
    </div>

    <div id="moduli-lezione-10" class="moduli-grid"> 
        <h3 style="color: #6f42c1; margin-top:0;">Lezione 10</h3> 
        <button onclick="iniziaQuiz(46)">Esercizio 1</button> 
        <button onclick="iniziaQuiz(47)">Esercizio 2</button> 
        <button onclick="iniziaQuiz(48)">Esercizio 3</button> 
        <button onclick="iniziaQuiz(49)">Esercizio 4</button> 
        <button onclick="iniziaQuiz(50)">Esercizio 5</button> 
    </div>

    <div id="moduli-lezione-11" class="moduli-grid"> 
        <h3 style="color: #28a745; margin-top:0;">Lezione 11</h3> 
        <button onclick="iniziaQuiz(51)">Esercizio 1</button> 
        <button onclick="iniziaQuiz(52)">Esercizio 2</button> 
        <button onclick="iniziaQuiz(53)">Esercizio 3</button> 
        <button onclick="iniziaQuiz(54)">Esercizio 4</button> 
        <button onclick="iniziaQuiz(55)">Esercizio 5</button> 
    </div>

    <div id="moduli-lezione-12" class="moduli-grid"> 
        <h3 style="color: #343a40; margin-top:0;">Lezione 12</h3> 
        <button onclick="iniziaQuiz(56)">Esercizio 1</button> 
        <button onclick="iniziaQuiz(57)">Esercizio 2</button> 
        <button onclick="iniziaQuiz(58)">Esercizio 3</button> 
        <button onclick="iniziaQuiz(59)">Esercizio 4</button> 
        <button onclick="iniziaQuiz(60)">Esercizio 5</button> 
    </div>

    <div style="margin-top:25px;"> 
      <button id="btn-back-lezione" onclick="tornaAlleLezioni()" style="background-color: #6c757d; display:none;">‚¨ÖÔ∏è Cambia Lezione</button> 
      <button id="btn-back-mode" onclick="tornaAllaModalita()" style="background-color: #444;">‚¨ÖÔ∏è Torna alla scelta modalit√†</button> 
    </div> 
  </div> 

  <h1 style="display:none;" id="titolo-quiz">Quiz a Scelta Multipla</h1> 
  <div class="stats" id="stats-container" style="display:none;"> 
    <div><strong>Punteggio:</strong> <span id="punteggio">0</span></div> 
    <div><strong>Domanda:</strong> <span id="contatore">0</span></div> 
  </div> 
   
  <div class="progress-container" id="progress-container" style="display:none; background-color: #444; border-radius: 30px; margin-bottom: 20px; overflow: hidden;"> 
    <div id="progress-bar" class="progress-bar-animate" style="width: 0%; height: 14px; background: linear-gradient(to right, #ff416c, #ff4b2b);"></div> 
  </div> 
   
  <div class="card" id="card-container" style="display:none;"> 
    <div id="domanda" style="font-size: 1.4em; font-weight: bold; border: 2px solid #007bff; padding: 20px; border-radius: 10px; background-color: #2a2e3d; color: white; margin-bottom: 20px;">Caricamento...</div> 
    <div id="risposte"></div> 
    <div id="feedback" style="margin-top: 15px;"></div> 
  </div> 
   
  <div class="controls" id="controls-container" style="display:none; text-align:center;"> 
    <button onclick="domandaPrecedente()">‚¨ÖÔ∏è Indietro</button> 
    <button onclick="prossimaDomanda()">‚û°Ô∏è Avanti</button> 
    <button class="btn-danger" onclick="terminaTest()">üõë Termina Test</button> 
    <button onclick="ricomincia()">üîÑ Ricomincia</button> 
    <button onclick="tornaAiQuiz()">‚¨ÖÔ∏è Torna al Menu</button> 
  </div> 
   
  <div id="recap"></div> 

  <div id="docente-container" style="display:none; max-width: 900px; margin: auto;"> 
    <h1 id="titolo-docente">Soluzioni Modulo</h1> 
    <div id="lista-docente"></div> 
    <div style="text-align:center; margin-top: 30px;"> 
      <button onclick="tornaAiQuiz()">‚¨ÖÔ∏è Torna al Menu</button> 
    </div> 
  </div> 

 <script> 
    let docenteMode = false; 
    let rispostaCorretta = ""; 
    let punteggio = 0; 
    let ultimaDomanda = null; 
    let risposteUtente = []; 
    let indexDomanda = 0; 
    let quizCorrente = 1; 
    let MAX_DOMANDE = 0; 
    const FEEDBACK_DELAY = 200; 

    function setDocenteMode(mode) { 
      if (mode) { 
        const pwd = prompt("Inserisci la password per accedere alla modalit√† docente:"); 
        if (pwd !== "admin123") { 
          alert("‚ùå Password errata!"); 
          return; 
        } 
      } 
        
      docenteMode = mode; 
      document.getElementById("start-container").style.display = "none"; 
      document.getElementById("quiz-buttons").style.display = "block"; 

      document.getElementById("quiz-title").textContent = mode ? "Tutti i Moduli (Modalit√† Docente)" : "Seleziona una Lezione"; 
        
      const lezioneContainer = document.getElementById("lezione-container"); 
      const btnBackLez = document.getElementById("btn-back-lezione"); 
      const btnBackMode = document.getElementById("btn-back-mode"); 

      // Array con gli ID dei moduli per ciclare e nascondere/mostrare
      const moduli = [1,2,3,4,5,6,7,8,9,10,11,12];

      if (mode) { 
        lezioneContainer.style.display = "none"; 
        moduli.forEach(i => document.getElementById(`moduli-lezione-${i}`).style.display = "grid");
        btnBackLez.style.display = "none"; 
        btnBackMode.style.display = "inline-block"; 
      } else { 
        lezioneContainer.style.display = "block";  
        moduli.forEach(i => document.getElementById(`moduli-lezione-${i}`).style.display = "none");
        btnBackLez.style.display = "none"; 
        btnBackMode.style.display = "inline-block"; 
      } 
    } 
      
    function mostraModuliQuiz(lezione) { 
      document.getElementById("lezione-container").style.display = "none"; 
      
      // Nascondi tutti
      for(let i=1; i<=12; i++){
          document.getElementById(`moduli-lezione-${i}`).style.display = "none";
      }

      // Mostra quello selezionato
      document.getElementById(`moduli-lezione-${lezione}`).style.display = "grid";

      document.getElementById("btn-back-lezione").style.display = "inline-block"; 
      document.getElementById("btn-back-mode").style.display = "none"; 
    } 

    function tornaAlleLezioni() { 
      for(let i=1; i<=12; i++){
          document.getElementById(`moduli-lezione-${i}`).style.display = "none";
      }
      document.getElementById("lezione-container").style.display = "block"; 
        
      document.getElementById("btn-back-lezione").style.display = "none"; 
      document.getElementById("btn-back-mode").style.display = "inline-block"; 
    } 

    async function fetchDomanda(index){ 
      const res = await fetch(`/quiz/${quizCorrente}/${index}`); 
      return await res.json(); 
    } 

    function aggiornaPunteggio(){ 
      punteggio = risposteUtente.reduce((acc,item)=> acc + (item && item.esito ? 1 : 0),0); 
      document.getElementById('punteggio').textContent = punteggio; 
    } 

    // --- LOGICA STUDENTE ---
    async function caricaDomanda(){ 
      if(MAX_DOMANDE===0){ 
        const res = await fetch(`/quiz_all/${quizCorrente}`); 
        const tutte = await res.json(); 
        if(!tutte.errore){ 
          MAX_DOMANDE = tutte.length; 
          document.getElementById("contatore").textContent = `0/${MAX_DOMANDE}`; 
        } 
      } 
      if(indexDomanda >= MAX_DOMANDE){ mostraRecap(); return; } 

      const domandaData = await fetchDomanda(indexDomanda); 
      if(domandaData.errore){ mostraRecap(); return; } 

      ultimaDomanda = domandaData; 
      document.getElementById('domanda').textContent = domandaData.domanda; 
      document.getElementById('contatore').textContent = `${indexDomanda+1}/${MAX_DOMANDE}`; 
      document.getElementById('progress-bar').style.width = Math.floor(((indexDomanda+1)/MAX_DOMANDE)*100) + "%"; 
      rispostaCorretta = domandaData.corretta; 

      const risposte = [...domandaData.risposte].sort(() => Math.random()-0.5); 
      const container = document.getElementById('risposte'); 
      container.innerHTML = ""; 
      document.getElementById('feedback').textContent = ""; 

      risposte.forEach((r,i)=>{ 
        const btn = document.createElement('div'); 
        btn.className = 'risposta'; 
        btn.style.animationDelay = `${i*0.1}s`; 
        btn.textContent = r; 
        btn.onclick = () => verificaRisposta(btn,r); 
        container.appendChild(btn); 
      }); 

      aggiornaPunteggio(); 
    } 

    function verificaRisposta(el, risposta){ 
      if(risposteUtente[indexDomanda]) return; 

      const corretto = risposta === rispostaCorretta; 
      el.classList.add(corretto ? "corretta" : "sbagliata"); 

      document.querySelectorAll('.risposta').forEach(b=>{ 
        b.onclick=null; 
        if(!corretto && b.textContent === rispostaCorretta) b.classList.add("corretta"); 
      }); 

      document.getElementById('feedback').textContent = corretto ? "‚úÖ Corretto!" : "‚ùå Sbagliato!"; 

      risposteUtente[indexDomanda] = { 
        domanda: ultimaDomanda.domanda, 
        rispostaUtente: risposta, 
        corretta: rispostaCorretta, 
        esito: corretto 
      }; 

      aggiornaPunteggio(); 
      setTimeout(()=>{ indexDomanda++; caricaDomanda(); }, FEEDBACK_DELAY); 
    } 

    function prossimaDomanda(){ indexDomanda++; caricaDomanda(); } 
    function domandaPrecedente(){ if(indexDomanda>0){ indexDomanda--; caricaDomanda(); } } 

    function mostraRecap(){ 
      document.getElementById('controls-container').style.display='none'; 
      document.getElementById('card-container').style.display='none';
      document.getElementById('stats-container').style.display='none';
      document.getElementById('progress-container').style.display='none';
      document.getElementById('titolo-quiz').style.display='none';

      const container = document.getElementById('recap'); 
      container.innerHTML = ""; 

      const sbagliate = MAX_DOMANDE - punteggio;
      
      let html = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: white;">üìä Risultato Finale</h1>
            <h2 style="color: #1a73e8;">Punteggio: ${punteggio} su ${MAX_DOMANDE}</h2>
            <div style="max-width: 300px; margin: 0 auto;">
                <canvas id="chartRecap"></canvas>
            </div>
        </div>
        <h3 style="text-align:center; margin-bottom: 20px;">Dettaglio Risposte:</h3>
      `;

      risposteUtente.forEach((item, index) => {
          if(!item) {
             item = { domanda: "Domanda non risposta", rispostaUtente: "Nessuna", esito: false, corretta: "N/D" };
          }

          const cssClass = item.esito ? "recap-card recap-correct" : "recap-card recap-wrong";
          const icon = item.esito ? "‚úÖ" : "‚ùå";
          const classColor = item.esito ? "text-success" : "text-danger";

          html += `
            <div class="${cssClass}">
                <div style="font-size: 0.9rem; color: #ccc;">Domanda ${index + 1}</div>
                <div class="recap-text"><strong>${item.domanda}</strong></div>
                <div class="recap-text">
                    Il tuo esito: <span class="${classColor}">${icon} ${item.rispostaUtente}</span>
                </div>
                ${!item.esito ? `<div class="recap-text" style="color: #ccc; margin-top:5px;">üëâ Risposta corretta: <span class="text-success">${item.corretta}</span></div>` : ''}
            </div>
          `;
      });

      html += `
        <div style="text-align:center; margin-top: 30px; margin-bottom: 50px;">
            <button onclick="tornaAiQuiz()" style="font-size: 1.2rem; padding: 15px 30px;">‚¨ÖÔ∏è Torna al Menu Principale</button>
        </div>
      `;

      container.innerHTML = html;

      const ctx = document.getElementById('chartRecap').getContext('2d');
      new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: ['Corrette', 'Sbagliate'],
              datasets: [{
                  data: [punteggio, sbagliate],
                  backgroundColor: ['#28a745', '#dc3545'],
                  borderWidth: 0
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  legend: { position: 'bottom', labels: { color: 'white' } }
              }
          }
      });
    }

    function ricomincia(){ 
      punteggio=0; indexDomanda=0; risposteUtente=[]; MAX_DOMANDE=0; 
      document.getElementById('punteggio').textContent="0"; 
      document.getElementById('controls-container').style.display='block'; 
      document.getElementById('progress-container').style.display='block'; 
      caricaDomanda(); 
    } 

    function terminaTest(){ indexDomanda=MAX_DOMANDE; mostraRecap(); } 

    function tornaAiQuiz(){ 
      document.getElementById('quiz-buttons').style.display='block'; 
      document.getElementById('titolo-quiz').style.display='none'; 
      document.getElementById('stats-container').style.display='none'; 
      document.getElementById('card-container').style.display='none'; 
      document.getElementById('controls-container').style.display='none'; 
      document.getElementById('progress-container').style.display='none'; 
      document.getElementById('recap').innerHTML=''; 
       
      document.getElementById('docente-container').style.display='none'; 

      const moduli = [1,2,3,4,5,6,7,8,9,10,11,12];

      if (docenteMode) { 
        document.getElementById("lezione-container").style.display = "none"; 
        moduli.forEach(i => document.getElementById(`moduli-lezione-${i}`).style.display = "grid");
      } else { 
        tornaAlleLezioni();  
      } 
    } 

    function tornaAllaModalita(){ 
      document.getElementById('quiz-buttons').style.display='none'; 
      document.getElementById('start-container').style.display='block'; 
      document.getElementById('lezione-container').style.display='none'; 
      // Nasconde tutti i moduli
      for(let i=1; i<=12; i++){
          document.getElementById(`moduli-lezione-${i}`).style.display = "none";
      }
    } 

    // --- FUNZIONI DOCENTE ---
    async function mostraSoluzioniDocente(id) {
        document.getElementById('quiz-buttons').style.display = 'none';
        document.getElementById('docente-container').style.display = 'block';
        document.getElementById('titolo-docente').textContent = "Soluzioni Esercizio #" + id;

        const container = document.getElementById('lista-docente');
        container.innerHTML = '<div style="text-align:center; padding:20px;">Caricamento domande...</div>';

        try {
            const res = await fetch(`/quiz_all/${id}`);
            const domande = await res.json();
            
            container.innerHTML = ""; 

            if (domande.errore || !Array.isArray(domande)) {
                container.innerHTML = "Errore nel caricamento delle domande.";
                return;
            }

            domande.forEach((d, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                
                let html = `<h3 style="color: #1a73e8; margin-top:0;">Domanda ${idx + 1}</h3>`;
                html += `<p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;">${d.domanda}</p>`;
                html += `<div>`;
                
                d.risposte.forEach(r => {
                    const isCorrect = (r === d.corretta);
                    const cssClass = isCorrect ? 'risposta-docente docente-corretta' : 'risposta-docente';
                    const icon = isCorrect ? '‚úÖ ' : '‚ö™ ';
                    
                    html += `<div class="${cssClass}">${icon}${r}</div>`;
                });
                
                html += `</div>`;
                card.innerHTML = html;
                container.appendChild(card);
            });

        } catch (e) {
            console.error(e);
            container.innerHTML = "Errore di connessione al database.";
        }
    }

    function iniziaQuiz(id) {
        quizCorrente = id;
        
        if (docenteMode) {
            mostraSoluzioniDocente(id);
            return;
        }

        indexDomanda = 0;
        punteggio = 0;
        risposteUtente = [];
        MAX_DOMANDE = 0;

        document.getElementById("quiz-buttons").style.display = "none";

        document.getElementById("titolo-quiz").style.display = "block";
        document.getElementById("stats-container").style.display = "flex";
        document.getElementById("progress-container").style.display = "block";
        document.getElementById("card-container").style.display = "block";
        document.getElementById("controls-container").style.display = "block";

        document.getElementById("punteggio").textContent = "0";
        document.getElementById("contatore").textContent = "0";
        document.getElementById("domanda").textContent = "Caricamento...";
        document.getElementById("risposte").innerHTML = "";
        document.getElementById("feedback").textContent = "";

        caricaDomanda();
     }
</script> 
</body> 
</html>
